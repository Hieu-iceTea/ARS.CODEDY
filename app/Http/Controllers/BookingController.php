<?php

namespace App\Http\Controllers;

use App\Http\Requests\BookingRequest;
use App\Model\Airport;
use App\Model\ExtraService;
use App\Model\FlightSchedule;
use App\Model\Passenger;
use App\Model\PayType;
use App\Model\Ticket;
use App\Utilities\Utility;
use App\Utilities\VNPay;
use Illuminate\Contracts\Foundation\Application;
use Illuminate\Contracts\View\Factory;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Routing\Redirector;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Str;
use Illuminate\View\View;

class BookingController extends Controller
{
    /**
     * Show the form for Booking/Step-1.
     *
     * @param BookingRequest $request
     * @return Application|Factory|RedirectResponse|Redirector|View
     */
    public function getStep1(Request $request)
    {
        //Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠p v√†o c√≥ null kh√¥ng? N·∫øu null th√¨ quay v·ªÅ trang ch·ªß v√† b√°o l·ªói
        if ($request->get('from') == '') {
            return redirect('/')
                ->with('notification', 'Please search for your flight first!')
                ->with('preloader', 'none');
        }

        //Get data from request:
        $airport_from_id = $request->get('from');
        $airport_to_id = $request->get('to');
        $departure_at = $request->get('departure');

        $adults = $request->get('adults');
        $children = $request->get('children');
        $infant = $request->get('infant');
        $totalPassenger = $adults + $children + $infant;

        //get data of Airport from DataBase:
        $airport_from = Airport::all()->where('airport_id', $airport_from_id)->first();
        $airport_to = Airport::all()->where('airport_id', $airport_to_id)->first();

        $searchInput = [
            'airport_from_name' => $airport_from->name,
            'airport_from_code' => $airport_from->code,
            'airport_to_name' => $airport_to->name,
            'airport_to_code' => $airport_to->code,
            'departure_at' => $departure_at,
            'adults' => $adults,
            'children' => $children,
            'infant' => $infant,
            'totalPassenger' => $totalPassenger,
        ];

        //get data Flight-Schedules from DataBase:
        $flightSchedules = FlightSchedule::where('airport_from_id', $airport_from_id)
            ->where('airport_to_id', $airport_to_id)
            ->where('departure_at', 'like', '%' . $departure_at . '%')
            ->get();

        if (count($flightSchedules) > 0) {
            return view('pages.booking.step-1', compact('flightSchedules', 'searchInput', 'airport_to'));
        } else {
            return redirect('/')
                ->with('notification', "Sorry, we don't have any flights yet with your chosen information!")
                ->with('preloader', 'none');
        }
    }

    /**
     * Receive data and redirect to the next page.
     *
     * @param BookingRequest $request
     * @return Application|RedirectResponse|Redirector
     */
    public function postStep1(BookingRequest $request)
    {
        $flight_schedule_id = $request->get('flight_schedule_id');
        if ($flight_schedule_id == '') {
            return redirect()->back()->withInput()->withErrors('Please choose flight');
        }

        //get data from form (in hidden-field)
        $booking_session = [
            'flight_schedule_id' => $request->get('flight_schedule_id'),
            'flightSchedule' => FlightSchedule::find($request->get('flight_schedule_id')),
            'seat_type' => $request->get('seat_type'),
            'seat_price' => $request->get('seat_price'),

            'passenger_count' => $request->get('passenger_count'),
        ];

        //put to session
        $this->updateSession('booking_session', $booking_session);

        return redirect('booking/step-2');
    }

    /**
     * Show the form for Booking/Step-2.
     *
     * @param Request $request
     */
    public function getStep2(Request $request)
    {
        //Ki·ªÉm tra phi√™n session c√≤n t·ªìn t·∫°i kh√¥ng? N·∫øu kh√¥ng th√¨ quay v·ªÅ trang ch·ªß v√† b√°o l·ªói
        if (!Session::has('booking_session') || Session::get('booking_session') === null) {
            return redirect('/')
                ->withErrors('Session expires. <br> please search again for your flight')
                ->with('preloader', 'none');
        }

        //get data from Session:
        $booking_session = Session::get('booking_session');


        $passenger_count = $booking_session['passenger_count'];

        return view('pages.booking.step-2', compact('passenger_count', 'booking_session'));
    }

    /**
     * Receive data and redirect to the next page.
     *
     * @param BookingRequest $request
     * @return Application|RedirectResponse|Redirector
     */
    public function postStep2(BookingRequest $request)
    {
        //get data from request:
        $new_data = [
            'passengers' => $request->get('passengers'),
            'contact' => $request->get('contact'),
        ];

        //update booking_session:
        $this->updateSession('booking_session', $new_data);

        return redirect('booking/step-3');
    }

    /**
     * Show the form for Booking/Step-3.
     *
     */
    public function getStep3()
    {
        //Ki·ªÉm tra phi√™n session c√≤n t·ªìn t·∫°i kh√¥ng? N·∫øu kh√¥ng th√¨ quay v·ªÅ trang ch·ªß v√† b√°o l·ªói
        if (!Session::has('booking_session') || Session::get('booking_session') === null) {
            return redirect('/')
                ->withErrors('Session expires! <br> please search again for your flight')
                ->with('preloader', 'none');
        }

        $booking_session = Session::get('booking_session');
        $extraServices = ExtraService::all();

        return view('pages.booking.step-3', compact('extraServices', 'booking_session'));
    }

    /**
     * Receive data and redirect to the next page.
     *
     * @param BookingRequest $request
     * @return Application|RedirectResponse|Redirector
     */
    public function postStep3(BookingRequest $request)
    {
        //get data from request:
        $new_data = [
            'extra_service_ids' => $request->get('extra_service_ids'),
            'extraService_total_price' => $request->get('extraService_total_price'),
        ];

        //update booking_session:
        $this->updateSession('booking_session', $new_data);

        return redirect('booking/step-4');
    }

    /**
     * Show the form for Booking/Step-4.
     *
     */
    public function getStep4()
    {
        //Ki·ªÉm tra phi√™n session c√≤n t·ªìn t·∫°i kh√¥ng? N·∫øu kh√¥ng th√¨ quay v·ªÅ trang ch·ªß v√† b√°o l·ªói
        if (!Session::has('booking_session') || Session::get('booking_session') === null) {
            return redirect('/')
                ->withErrors('Session expires! <br> please search again for your flight')
                ->with('preloader', 'none');
        }

        $booking_session = Session::get('booking_session');
        $payTypes = PayType::all();

        $data = array_merge($booking_session, ['payTypes' => $payTypes]);

        return view('pages.booking.step-4', $data);
    }

    /**
     * Receive data and redirect to the completed page.
     *
     * @param BookingRequest $request
     * @return Application|RedirectResponse|Redirector
     */
    public function postStep4(BookingRequest $request)
    {
        $pay_type_id = $request->get('pay_type');

        //N·∫øu PayType ch∆∞a ƒë∆∞∆°c k√≠ch ho·∫°t, th√¨ quay l·∫°i trang c≈© b√°o l·ªói:
        if (PayType::where('pay_type_id', $pay_type_id)->first()->active == false) {

            //L·∫•y t√™n c√°c ph∆∞∆°ng th·ª©c thanh to√°n ƒë∆∞·ª£c h·ªó tr·ª£
            $Payment_methods_are_active = PayType::all()->where('active', true);
            $Payment_methods_are_active_name = '<br><br>List of supported payment methods:<br>';
            foreach ($Payment_methods_are_active as $item) {
                $Payment_methods_are_active_name .= '- ' . $item->name . '<br>';
            }

            return back()
                ->withInput()
                ->setTargetUrl('#payment_details')
                ->withErrors('Currently, we do not support this payment method. <br> Please choose another one. Thanks! üíúüíúüíú' . $Payment_methods_are_active_name)
                ->with('preloader', 'none');
        }

        //Insert data
        $ticket = $this->createTicket($request);

        //N·∫øu l·ª±a ch·ªçn thanh to√°n sau
        if ($pay_type_id == Utility::pay_type_PayLater) {
            $this->sendEmail($ticket);

            return redirect('booking/complete/' . $ticket->ticket_id);
        }

        //N·∫øu l·ª±a ch·ªçn thanh to√°n online qua VNPay
        if ($pay_type_id == Utility::pay_type_VNPay) {
            //L·∫•y Url c·ªïng thanh to√°n
            $data_url = VNPay::vnpay_create_payment([
                'vnp_TxnRef' => $ticket->ticket_id,
                'vnp_OrderInfo' => 'Th√¥ng tin m√¥ t·∫£ ƒë∆°n h√†ng n√†y ·ªü ƒë√¢y',
                'vnp_Amount' => $ticket->total_price,
            ]);

            //Chuy·ªÉn h∆∞·ªõng ƒë·∫øn c·ªïng Url thanh to√°n v·ª´a l·∫•y ƒë∆∞·ª£c
            return redirect()->to($data_url);
        }
    }

    /**
     * Hi·ªán th·ªã form thanh to√°n HO·∫∂C x·ª≠ l√Ω thanh to√°n ·ªü ƒë√¢y
     *
     * @param Request $request
     * @return Application|RedirectResponse|Redirector
     */
    public function getPayment(Request $request)
    {
        //L·∫•y data t·ª´ URL (do VNPay g·ª≠i v·ªÅ qua $vnp_Returnurl)
        $vnp_ResponseCode = $request->get('vnp_ResponseCode'); //M√£ ph·∫£n h·ªìi k·∫øt qu·∫£ thanh to√°n. 00 = Th√†nh c√¥ng
        $vnp_TxnRef = $request->get('vnp_TxnRef'); //ticket_id

        if ($vnp_ResponseCode != null) {
            //N·∫øu giao d·ªãch b·ªã h·ªßy do ng∆∞·ªùi d√πng
            if ($vnp_ResponseCode == 24) {
                //C·∫≠p nh·∫≠t b·∫£n ghi trong DataBase: status = ƒê√£ H·ªßy
                $ticket = Ticket::where('ticket_id', '=', $vnp_TxnRef)->update([
                    //'deleted' => true,
                    'status' => Utility::ticket_status_Cancel,
                    'description' => 'v√© b·ªã H·ª¶Y khi thanh to√°n b·∫±ng VNPay (Demo test m·ªõi ghi th·∫ø n√†y th√¥i. Ahihi)',
                ]);

                echo "L·ªói: B·∫°n ƒë√£ h·ªßy giao d·ªãch. D·ªØ li·ªáu booking c·ªßa b·∫°n s·∫Ω b·ªã x√≥a kh·ªèi h·ªá th·ªëng.";
            }

            //N·∫øu giao d·ªãch th√†nh c√¥ng
            if ($vnp_ResponseCode == 00) {
                //c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√£ thanh to√°n trong DataBase (status)
                Ticket::where('ticket_id', '=', $vnp_TxnRef)->update([
                    'status' => Utility::ticket_status_Paid,
                    'description' => 'V√© ƒë∆∞·ª£c thanh to√°n b·∫±ng VNPay (Demo test m·ªõi ghi th·∫ø n√†y th√¥i. Ahihi)',
                ]);

                $ticket = Ticket::all()->where('ticket_id', '=', $vnp_TxnRef)->first();
                $this->sendEmail($ticket);

                return redirect('booking/complete/' . $vnp_TxnRef);
            }

            //N·∫øu c√≥ b·∫•t c·ª© l·ªói g√¨ kh√°c
            echo "L·ªói: thanh to√°n VNPay kh√¥ng th√†nh c√¥ng. Chi ti·∫øt xin li√™n h·ªá qu·∫£n tr·ªã vi√™n.";
        }
    }

    /**
     * Hi·ªán th·ªã th√¥ng b√°o ƒë·∫∑t v√© th√†nh c√¥ng
     *
     * @param $id
     * @return Application|Factory|View
     */
    public function complete($id)
    {
        //X√≥a session li√™n quan ƒë·∫øn booking
        Session::forget('booking_session');

        //get code from DataBase by ticket_id
        $ticket = Ticket::find($id);

        return view('pages.booking.complete', compact('ticket'));
    }

    // = = = = = = = = = = = = = = = = = = = = Common method = = = = = = = = = = = = = = = = = = = = //

    /**
     * C·∫≠p nh·∫≠t session.
     * Th√™m $data m·ªõi v√†o session hi·ªán t·∫°i theo $key.
     * N·∫øu data m·ªõi tr√πng t√™n c√≥ s·∫µn trong session ƒëang g·ªçi th√¨ ghi ƒë√® n√≥.
     *
     * @param $key
     * @param $data
     */
    private function updateSession($key, $data)
    {
        //get data from Session:
        $session = Session::get($key) ?? [];

        //update $session:
        $session = array_merge($session, $data);

        //put new data to session:
        Session::put($key, $session);
    }

    /**
     * T·∫°o v√© m·ªõi trong Database v·ªõi t·∫•t c·∫£ th√¥ng tin trong $request & $booking_session
     *
     * @param $request
     * @return RedirectResponse|mixed
     */
    private function createTicket($request)
    {
        //Get data from Session & Request:
        $booking_session = Session::get('booking_session');
        $pay_type_id = $request->get('pay_type');

        // = = = = = = = = = = = = = = = = = = = = [01] Insert to Ticket = = = = = = = = = = = = = = = = = = = =
        $ticket = new Ticket(); //Kh·ªüi t·∫°o Model m·ªõi
        $ticket->user_id = Auth::user()->user_id ?? null;
        $ticket->flight_schedule_id = $booking_session['flight_schedule_id'];
        //$ticket->promotion_id = 'promotion_id';
        $ticket->pay_type_id = $pay_type_id;
        $ticket->extra_service_ids = implode(',', $booking_session['extra_service_ids'] ?? []);
        $ticket->seat_type = $booking_session['seat_type'];
        //$ticket->status = 'status'; //ƒë√£ ƒë·∫∑t m·∫∑c ƒë·ªãnh l√† 1 trong DB
        $ticket->code = Str::upper(Str::random(6));
        $ticket->contact_gender = $booking_session['contact']['contact_gender'];
        $ticket->contact_first_name = $booking_session['contact']['contact_firstname'];
        $ticket->contact_last_name = $booking_session['contact']['contact_lastname'];
        $ticket->contact_email = $booking_session['contact']['contact_email'];
        $ticket->contact_phone = $booking_session['contact']['contact_phone'];
        $ticket->contact_address = $booking_session['contact']['contact_address'];
        $ticket->total_price = $booking_session['passenger_count']['total'] * $booking_session['seat_price'] + $booking_session['extraService_total_price'] + 500000;
        $ticket->total_passenger = $booking_session['passenger_count']['total'];
        //$ticket->description = 'description';
        $ticket->save(); //L∆∞u Model v·ª´a kh·ªüi t·∫°o v√† g√°n gi√° tr·ªã

        if ($ticket->ticket_id == '') {
            return back()->withErrors('Cannot add data to table: [Ticket]')->with('preloader', 'none');
        }

        // = = = = = = = = = = = = = = = = = = = = [02] Insert to Passenger = = = = = = = = = = = = = = = = = = = =
        $passengers = $booking_session['passengers'];
        foreach ($passengers as $item) {
            $passenger = new Passenger(); //Kh·ªüi t·∫°o Model m·ªõi
            $passenger->ticket_id = $ticket->ticket_id;
            $passenger->gender = $item['gender'];
            $passenger->passenger_type = $item['passenger_type'];
            $passenger->first_name = $item['first_name'];
            $passenger->last_name = $item['last_name'];
            $passenger->dob = $item['dob'];
            $passenger->with_passenger = $item['with_passenger'] ?? null;
            $passenger->save(); //L∆∞u Model v·ª´a kh·ªüi t·∫°o v√† g√°n gi√° tr·ªã

            if ($passenger->passenger_id == '') {
                return back()->withErrors('Cannot add data to table: [Passenger]')->with('preloader', 'none');
            }
        }

        // = = = = = = = = = = = = = = = = = = = = [03] C·∫≠p nh·∫≠t b·∫£ng kh√°c = = = = = = = = = = = = = = = = = = = =
        //Tr·ª´ s·ªë l∆∞·ª£ng gh·∫ø (s·∫Ω l√†m s·ªõm...)

        return $ticket;
    }

    /**
     * G·ª≠i email th√¥ng b√°o Booking
     *
     * @param Ticket $ticket
     */
    private function sendEmail(Ticket $ticket)
    {
        //Send email:
        $email_to = $ticket->contact_email;
        Mail::send('pages.booking.email', compact('ticket'), function ($message) use ($email_to) {
            $message->from('ars.codedy@gmail.com', 'ARS.CODEDY');
            $message->to($email_to, $email_to);
            //$message->cc('', ''); //g·ª≠i cho ch·ªß c·ª≠a h√†ng
            $message->subject('Your Reservation Details');
        });
    }
}
